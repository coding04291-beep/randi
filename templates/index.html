<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—…ë‹¤ìš´ ëœë”” | randi.ac</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> .glow { text-shadow: 0 0 15px rgba(168, 85, 247, 0.6); } </style>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-[#1e293b] rounded-[2rem] shadow-2xl border border-slate-700 overflow-hidden">
        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-8 text-center">
            <h1 class="text-3xl font-black text-white tracking-tight italic">UP-DOWN</h1>
            <div id="streak-ui" class="hidden mt-2 text-yellow-400 font-bold tracking-widest">
                ğŸ”¥ STREAK: <span id="streak-count">0</span>
            </div>
        </div>

        <div class="p-8">
            <div id="setup-area" class="space-y-4">
                <input id="handle" type="text" placeholder="ë°±ì¤€ ì•„ì´ë”” ì…ë ¥" class="w-full bg-[#334155] border-none rounded-xl p-4 outline-none focus:ring-2 ring-indigo-500 text-white">
                <select id="start-tier" class="w-full bg-[#334155] border-none rounded-xl p-4 outline-none focus:ring-2 ring-indigo-500 text-white"></select>
                <button onclick="startGame()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-xl font-bold shadow-lg transition-transform active:scale-95">ì‹œì‘í•˜ê¸°</button>
            </div>

            <div id="game-area" class="hidden space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Current Tier</p>
                        <h2 id="display-tier" class="text-4xl font-black text-indigo-400 glow">--</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Time Left</p>
                        <h2 id="timer" class="text-3xl font-mono font-bold text-rose-500">60:00</h2>
                    </div>
                </div>

                <div class="bg-[#334155] rounded-2xl p-6 border border-slate-600 text-center">
                    <p id="prob-no" class="text-xs text-slate-400 mb-1 font-mono uppercase">No. -----</p>
                    <h3 id="prob-title" class="text-xl font-bold mb-4 text-white">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
                    <a id="prob-link" href="#" target="_blank" class="inline-block bg-indigo-500/20 text-indigo-300 px-6 py-2 rounded-full text-sm font-bold border border-indigo-500/30 hover:bg-indigo-500/40">ë¬¸ì œ ì—´ê¸° â”</a>
                </div>

                <div id="action-buttons" class="grid grid-cols-2 gap-4">
                    <button id="btn-check" onclick="checkStatus()" class="bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-bold shadow-lg transition-all text-white">ì„±ê³µ í™•ì¸</button>
                    <button id="btn-giveup" onclick="giveUp()" class="bg-rose-600 hover:bg-rose-500 py-4 rounded-xl font-bold shadow-lg transition-all text-white">í¬ê¸°</button>
                </div>
                
                <button id="btn-next" onclick="nextProblem()" class="hidden w-full bg-amber-500 hover:bg-amber-400 py-4 rounded-xl font-bold text-[#1e293b] shadow-lg transition-all animate-bounce">
                    ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¤ìŒ ë‹¨ê³„ ì‹œì‘! â”
                </button>

                <button onclick="resetGame()" class="w-full mt-4 bg-slate-800 hover:bg-slate-700 py-3 rounded-xl font-bold text-slate-500 text-[10px] uppercase tracking-[0.2em] transition-all border border-slate-700">
                    Reset Game
                </button>
            </div>
        </div>
    </div>

    <script>
        const TIER_NAMES = ["Unrated", "B5", "B4", "B3", "B2", "B1", "S5", "S4", "S3", "S2", "S1", "G5", "G4", "G3", "G2", "G1", "P5", "P4", "P3", "P2", "P1", "D5", "D4", "D3", "D2", "D1", "R5", "R4", "R3", "R2", "R1"];
        let state = JSON.parse(localStorage.getItem('ud_save')) || { isPlaying: false, tier: 13, streak: 0, handle: '', startTime: null, prob: null, isSolved: false };

        const select = document.getElementById('start-tier');
        TIER_NAMES.forEach((n, i) => { if(i>0) select.add(new Option(n, i, false, i===13)) });

        function save() { localStorage.setItem('ud_save', JSON.stringify(state)); }

        window.onload = () => { if(state.isPlaying && state.prob) renderGame(); };

        async function startGame() {
            state.handle = document.getElementById('handle').value.trim();
            state.tier = parseInt(select.value);
            if(!state.handle) return alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            state.isPlaying = true;
            state.streak = 0;
            state.isSolved = false;
            await fetchProblem();
        }

        async function fetchProblem() {
            try {
                const res = await fetch(`/get-problem?tier=${state.tier}&handle=${state.handle}`);
                const data = await res.json();
                if(data.problemId) {
                    state.prob = data;
                    state.startTime = Date.now();
                    state.isSolved = false;
                    save();
                    renderGame();
                }
            } catch(e) { alert("ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
        }

        function renderGame() {
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('streak-ui').classList.remove('hidden');
            document.getElementById('streak-count').innerText = state.streak;
            document.getElementById('display-tier').innerText = TIER_NAMES[state.tier];
            document.getElementById('prob-no').innerText = `No. ${state.prob.problemId}`;
            document.getElementById('prob-title').innerText = state.prob.titleKo;
            document.getElementById('prob-link').href = `https://www.acmicpc.net/problem/${state.prob.problemId}`;
            
            if(state.isSolved) {
                showNextButton();
            } else {
                showActionButtons();
                startTimer();
            }
        }

        function startTimer() {
            clearInterval(window.timerInt);
            window.timerInt = setInterval(() => {
                const remain = 3600 - Math.floor((Date.now() - state.startTime) / 1000);
                if(remain <= 0) { 
                    clearInterval(window.timerInt);
                    alert("ì‹œê°„ ì´ˆê³¼! íŒ¨ë„í‹°ë¥¼ ë°›ê³  ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤."); 
                    // ì‹œê°„ì´ ë‹¤ ë˜ë©´ ìë™ìœ¼ë¡œ giveUp ë¡œì§ ì‹¤í–‰
                    processFailure(); 
                }
                const m = Math.floor(remain/60);
                const s = (remain%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        async function checkStatus() {
            const res = await fetch(`/check-status?handle=${state.handle}&problemId=${state.prob.problemId}`);
            const data = await res.json();
            if(data.solved) {
                state.isSolved = true;
                state.streak++;
                save();
                clearInterval(window.timerInt);
                showNextButton();
            } else {
                alert("ì•„ì§ ì•ˆ í’€ì—ˆê±°ë‚˜ ë°˜ì˜ ì „ì…ë‹ˆë‹¤.");
            }
        }

        function showNextButton() {
            document.getElementById('action-buttons').classList.add('hidden');
            document.getElementById('btn-next').classList.remove('hidden');
            document.getElementById('timer').innerText = "DONE!";
            document.getElementById('timer').className = "text-3xl font-mono font-bold text-emerald-500";
        }

        function showActionButtons() {
            document.getElementById('action-buttons').classList.remove('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('timer').className = "text-3xl font-mono font-bold text-rose-500";
        }

        async function nextProblem() {
            state.tier = Math.min(30, state.tier + 1);
            await fetchProblem();
        }

        // í¬ê¸° ë˜ëŠ” ì‹¤íŒ¨ ì²˜ë¦¬ í†µí•© ë¡œì§
        async function processFailure() {
            if (state.streak > 0) state.streak--;
            state.tier = Math.max(1, state.tier - 1);
            save();
            await fetchProblem();
        }

        async function giveUp() {
            if (!confirm("ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í‹°ì–´ê°€ í•˜ë½í•˜ê³  ìƒˆ ë¬¸ì œê°€ ë°°ì •ë©ë‹ˆë‹¤.")) return;
            await processFailure();
        }

        function forceReset() {
            clearInterval(window.timerInt);
            state = { isPlaying: false, tier: 13, streak: 0, handle: '', startTime: null, prob: null, isSolved: false };
            localStorage.removeItem('ud_save');
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('streak-ui').classList.add('hidden');
            document.getElementById('setup-area').classList.remove('hidden');
        }

        function resetGame() {
            if(!confirm("ì§„í–‰ ìƒí™©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            forceReset();
        }
    </script>
</body>
</html>
