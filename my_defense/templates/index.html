<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±ì¤€ ì—…ë‹¤ìš´ ëœë”” - íŒŒì´ë„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tier-glow { text-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .progress-bar { transition: width 1s linear; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md bg-[#1e293b] rounded-[2rem] shadow-2xl border border-slate-700 overflow-hidden">
        <div class="bg-gradient-to-br from-purple-600 to-blue-700 p-8 text-center relative">
            <div id="streak-container" class="absolute top-4 right-4 bg-black/20 px-3 py-1 rounded-full text-xs font-bold text-yellow-400 border border-yellow-500/30">
                ğŸ”¥ <span id="streak-count">0</span> STREAK
            </div>
            <h1 class="text-3xl font-black tracking-tight text-white mb-1">UP-DOWN</h1>
            <p class="text-purple-100 text-sm font-medium opacity-80">RANDOM DEFENSE</p>
        </div>

        <div class="p-8">
            <div id="setup-area" class="space-y-4">
                <input id="handle" type="text" placeholder="ë°±ì¤€ ì•„ì´ë””" 
                       class="w-full bg-[#334155] border-none rounded-2xl p-4 outline-none focus:ring-2 ring-purple-500 transition">
                <select id="start-tier" class="w-full bg-[#334155] border-none rounded-2xl p-4 outline-none focus:ring-2 ring-purple-500"></select>
                <button onclick="startGame()" class="w-full bg-purple-600 hover:bg-purple-500 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-purple-500/20 transition-all active:scale-95">
                    ë””íœìŠ¤ ì‹œì‘
                </button>
            </div>

            <div id="game-area" class="hidden space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-tighter">Current Level</p>
                        <h2 id="display-tier" class="text-4xl font-black text-purple-400 tier-glow">G3</h2>
                    </div>
                    <div class="text-right">
                        <p id="timer-label" class="text-slate-400 text-xs font-bold uppercase tracking-tighter">Time Left</p>
                        <h2 id="timer" class="text-3xl font-mono font-bold text-rose-500">60:00</h2>
                    </div>
                </div>

                <div class="bg-[#334155] rounded-3xl p-6 border border-slate-600 shadow-inner">
                    <p id="problem-no" class="text-purple-400 font-mono text-xs mb-1 font-bold tracking-widest uppercase">Problem No. -----</p>
                    <h3 id="problem-title" class="text-xl font-bold mb-4 leading-tight">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h3>
                    <a id="problem-link" href="#" target="_blank" 
                       class="inline-block bg-[#1e293b] hover:bg-black px-6 py-2 rounded-full text-sm font-bold border border-slate-500 transition-colors">
                       ë¬¸ì œ ë³´ëŸ¬ê°€ê¸° â”
                    </a>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="checkSuccess()" class="bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-bold shadow-lg shadow-emerald-900/20 transition-all active:scale-95">ì„±ê³µ (UP)</button>
                    <button onclick="giveUp()" class="bg-rose-600 hover:bg-rose-500 py-4 rounded-2xl font-bold shadow-lg shadow-rose-900/20 transition-all active:scale-95">í¬ê¸° (DOWN)</button>
                </div>

                <button onclick="resetWholeGame()" class="w-full text-slate-500 text-xs font-medium hover:text-slate-300 transition underline underline-offset-4">
                    ê²Œì„ ì´ˆê¸°í™” ë° ì•„ì´ë”” ë³€ê²½
                </button>
            </div>
        </div>
    </div>

    <script>
        const TIER_NAMES = ["Unrated", "B5", "B4", "B3", "B2", "B1", "S5", "S4", "S3", "S2", "S1", "G5", "G4", "G3", "G2", "G1", "P5", "P4", "P3", "P2", "P1", "D5", "D4", "D3", "D2", "D1", "R5", "R4", "R3", "R2", "R1"];
        let timerInterval;
        const TIME_LIMIT = 3600; // 1ì‹œê°„ (ì´ˆ ë‹¨ìœ„)

        // í‹°ì–´ ì„ íƒì°½ ì˜µì…˜ ìë™ ìƒì„±
        const select = document.getElementById('start-tier');
        TIER_NAMES.forEach((name, i) => {
            if(i === 0) return;
            const opt = new Option(name, i);
            if(i === 13) opt.selected = true;
            select.add(opt);
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë³µì›
        window.onload = () => {
            const saved = localStorage.getItem('ud_defense_save');
            if(saved) {
                const data = JSON.parse(saved);
                if(data.isPlaying) resumeGame(data);
            }
        };

        function updateStorage(obj) {
            const current = JSON.parse(localStorage.getItem('ud_defense_save') || '{}');
            localStorage.setItem('ud_defense_save', JSON.stringify({...current, ...obj}));
        }

        async function startGame() {
            const handle = document.getElementById('handle').value.trim();
            const tier = parseInt(document.getElementById('start-tier').value);
            if(!handle) return alert("ë°±ì¤€ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            const newState = {
                handle: handle,
                currentTier: tier,
                streak: 0,
                isPlaying: true,
                startTime: Math.floor(Date.now() / 1000),
                currentProblem: null
            };
            updateStorage(newState);
            resumeGame(newState);
        }

        async function resumeGame(state) {
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('streak-count').innerText = state.streak;
            document.getElementById('display-tier').innerText = TIER_NAMES[state.currentTier];

            if(!state.currentProblem) {
                await fetchNewProblem();
            } else {
                renderProblem(state.currentProblem);
                startTimer(state.startTime);
            }
        }

        async function fetchNewProblem() {
            const state = JSON.parse(localStorage.getItem('ud_defense_save'));
            document.getElementById('problem-title').innerText = "ìƒˆ ë¬¸ì œ ì°¾ëŠ” ì¤‘...";
            
            const res = await fetch(`/get-problem?tier=${state.currentTier}&handle=${state.handle}`);
            const data = await res.json();
            
            if(data.problemId) {
                const now = Math.floor(Date.now() / 1000);
                updateStorage({ currentProblem: data, startTime: now });
                renderProblem(data);
                startTimer(now);
            } else {
                alert("ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í‹°ì–´ë¥¼ ì¡°ì •í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
            }
        }

        function renderProblem(prob) {
            document.getElementById('problem-no').innerText = `Problem No. ${prob.problemId}`;
            document.getElementById('problem-title').innerText = prob.titleKo;
            document.getElementById('problem-link').href = `https://www.acmicpc.net/problem/${prob.problemId}`;
            document.getElementById('display-tier').innerText = TIER_NAMES[prob.level];
        }

        function startTimer(startTime) {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Math.floor(Date.now() / 1000);
                const elapsed = now - startTime;
                const remain = TIME_LIMIT - elapsed;

                if(remain <= 0) {
                    clearInterval(timerInterval);
                    alert("ì‹œê°„ ì¢…ë£Œ! í‹°ì–´ê°€ í•˜ë½í•©ë‹ˆë‹¤.");
                    giveUp();
                } else {
                    const m = Math.floor(remain / 60);
                    const s = remain % 60;
                    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                }
            }, 1000);
        }

        async function checkSuccess() {
            const state = JSON.parse(localStorage.getItem('ud_defense_save'));
            const res = await fetch(`/check-status?handle=${state.handle}&problemId=${state.currentProblem.problemId}`);
            const data = await res.json();

            if(data.solved) {
                const newTier = Math.min(30, state.currentTier + 1);
                const newStreak = state.streak + 1;
                alert(`ì„±ê³µ! ${newStreak}ì—°ì† ë¬¸ì œí’ˆ! (í‹°ì–´ ì—…: ${TIER_NAMES[newTier]})`);
                updateStorage({ currentTier: newTier, streak: newStreak, currentProblem: null });
                fetchNewProblem();
            } else {
                alert("ì•„ì§ í’€ì§€ ì•Šì•˜ê±°ë‚˜ Solved.acì— ë°˜ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        }

        async function giveUp() {
            const state = JSON.parse(localStorage.getItem('ud_defense_save'));
            const newTier = Math.max(1, state.currentTier - 1);
            alert(`í¬ê¸°í–ˆìŠµë‹ˆë‹¤... (í‹°ì–´ í•˜ë½: ${TIER_NAMES[newTier]})`);
            updateStorage({ currentTier: newTier, streak: 0, currentProblem: null });
            fetchNewProblem();
        }

        function resetWholeGame() {
            if(confirm("ëª¨ë“  ìŠ¤íŠ¸ë¦­ê³¼ ì§„í–‰ ìƒí™©ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
                localStorage.removeItem('ud_defense_save');
                location.reload();
            }
        }
    </script>
</body>
</html>